<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HIP-3 RWA Arbitrage Scanner</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fff;
            color: #333;
            font-size: 12px;
            padding: 12px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .header h1 { font-size: 16px; font-weight: 600; }
        .status-bar { display: flex; gap: 12px; font-size: 10px; color: #666; }
        .status-item { display: flex; align-items: center; gap: 4px; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; }
        .status-dot.live { background: #22c55e; }
        .status-dot.error { background: #ef4444; }
        .status-dot.loading { background: #f59e0b; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .api-status {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 10px;
        }
        .api-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            background: #fff;
            border-radius: 3px;
            border: 1px solid #e5e5e5;
        }
        .api-item.live { border-color: #22c55e; }
        .api-item.error { border-color: #ef4444; opacity: 0.6; }

        .stats {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .stat { display: flex; gap: 4px; }
        .stat-value { font-weight: 600; color: #111; }
        .stat-label { color: #666; }

        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: #fff;
            color: #666;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        .tab-btn:hover { border-color: #999; }
        .tab-btn.active { background: #111; color: #fff; border-color: #111; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 8px;
        }
        .card {
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            padding: 10px;
            background: #fff;
        }
        .card.has-arb { border-color: #22c55e; background: #f0fdf4; }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .card-title {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            font-size: 13px;
        }
        .card-badge {
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 3px;
            background: #f0f0f0;
            color: #666;
        }
        .card-badge.arb {
            background: #dcfce7;
            color: #166534;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #f5f5f5;
            font-size: 11px;
        }
        .price-row:last-child { border-bottom: none; }
        .price-row .dex-name {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #666;
            min-width: 100px;
        }
        .price-row .dex-name .live-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #22c55e;
        }
        .price-row .price {
            font-weight: 500;
            font-family: 'SF Mono', Monaco, monospace;
        }
        .price-row .spread {
            font-size: 10px;
            color: #666;
        }
        .price-row.best-buy { background: #f0fdf4; }
        .price-row.best-sell { background: #fef2f2; }

        .arb-info {
            margin-top: 8px;
            padding: 6px 8px;
            background: #dcfce7;
            border-radius: 4px;
            font-size: 10px;
            color: #166534;
        }
        .arb-info strong { font-weight: 600; }

        .no-data {
            color: #999;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç HIP-3 RWA Arbitrage Scanner</h1>
        <div class="status-bar">
            <div class="status-item">
                <span class="status-dot loading" id="statusDot"></span>
                <span>Last: <span id="lastUpdate">--:--:--</span></span>
            </div>
            <div class="status-item">Auto-refresh: 10s</div>
        </div>
    </div>

    <div class="api-status" id="apiStatus">
        <span style="color:#666">API Status:</span>
    </div>

    <div class="stats">
        <div class="stat"><span class="stat-value" id="totalAssets">0</span><span class="stat-label">Assets</span></div>
        <div class="stat"><span class="stat-value" id="totalDexs">0</span><span class="stat-label">DEXs</span></div>
        <div class="stat"><span class="stat-value" id="arbCount">0</span><span class="stat-label">Arb Opps</span></div>
        <div class="stat"><span class="stat-value" id="liveFeeds">0</span><span class="stat-label">Live Feeds</span></div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" data-cat="all">All</button>
        <button class="tab-btn" data-cat="stock">Stocks</button>
        <button class="tab-btn" data-cat="index">Index</button>
        <button class="tab-btn" data-cat="commodity">Commodities</button>
        <button class="tab-btn" data-cat="forex">Forex</button>
        <button class="tab-btn" data-cat="preipo">Pre-IPO</button>
        <button class="tab-btn" data-cat="crypto">Crypto</button>
    </div>

    <div class="grid" id="assetGrid"></div>

    <script>
        // HIP-3 DEX configurations
        const HIP3_DEXS = ['xyz', 'flx', 'vntl', 'hyna'];
        
        // Asset categorization
        const ASSET_CATEGORIES = {
            // Stocks
            'AAPL': 'stock', 'AMD': 'stock', 'AMZN': 'stock', 'BABA': 'stock',
            'COIN': 'stock', 'COST': 'stock', 'CRCL': 'stock', 'GOOGL': 'stock',
            'HOOD': 'stock', 'INTC': 'stock', 'LLY': 'stock', 'META': 'stock',
            'MSFT': 'stock', 'MSTR': 'stock', 'MU': 'stock', 'NFLX': 'stock',
            'NVDA': 'stock', 'ORCL': 'stock', 'PLTR': 'stock', 'RIVN': 'stock',
            'SKHX': 'stock', 'SNDK': 'stock', 'TSLA': 'stock', 'TSM': 'stock',
            // Index
            'XYZ100': 'index', 'MAG7': 'index', 'SEMIS': 'index', 'ROBOT': 'index', 'INFOTECH': 'index',
            // Commodities
            'GOLD': 'commodity', 'SILVER': 'commodity', 'CL': 'commodity', 'OIL': 'commodity',
            'COPPER': 'commodity', 'GAS': 'commodity',
            // Forex
            'EUR': 'forex', 'JPY': 'forex',
            // Pre-IPO
            'SPACEX': 'preipo', 'OPENAI': 'preipo', 'ANTHROPIC': 'preipo',
            // Crypto (HIP-3 specific)
            'XMR': 'crypto', 'BTC': 'crypto', 'ETH': 'crypto', 'SOL': 'crypto',
            'HYPE': 'crypto', 'LIT': 'crypto', 'ZEC': 'crypto', 'XRP': 'crypto',
            'LIGHTER': 'crypto', 'BNB': 'crypto', 'DOGE': 'crypto',
        };

        const ASSET_ICONS = {
            'AAPL': 'üçé', 'NVDA': 'üíö', 'TSLA': '‚ö°', 'GOOGL': 'üîç', 'AMZN': 'üì¶',
            'MSFT': 'ü™ü', 'META': 'üë§', 'PLTR': 'üîÆ', 'HOOD': 'üèπ', 'COIN': 'ü™ô',
            'NFLX': 'üé¨', 'AMD': 'üíª', 'MSTR': '‚Çø', 'GOLD': 'ü•á', 'SILVER': 'ü•à',
            'XYZ100': 'üìä', 'SPACEX': 'üöÄ', 'OPENAI': 'ü§ñ', 'ANTHROPIC': 'üß†',
            'EUR': 'üí∂', 'JPY': 'üí¥', 'CL': 'üõ¢Ô∏è', 'OIL': 'üõ¢Ô∏è', 'COPPER': 'üî∂',
            'XMR': 'üîí', 'BTC': '‚Çø', 'ETH': '‚ü†', 'SOL': '‚òÄÔ∏è', 'HYPE': 'üî•',
            'MAG7': 'üìà', 'SEMIS': 'üíæ', 'ROBOT': 'ü§ñ', 'INFOTECH': 'üíª',
            'INTC': 'üîµ', 'ORCL': 'üî¥', 'MU': 'üíø', 'BABA': 'üè™', 'LLY': 'üíä',
            'TSM': 'üè≠', 'RIVN': 'üöô', 'GAS': '‚õΩ', 'ZEC': 'üîê', 'XRP': 'üíß',
            'BNB': 'üü°', 'DOGE': 'üêï', 'LIGHTER': 'üî¶', 'LIT': 'üî•',
        };

        // External DEX configurations for arbitrage comparison
        const EXTERNAL_DEXS = {
            aster: { name: 'Aster', tickers: { 'GOLD': 'XAUUSDT', 'SILVER': 'XAGUSDT' } },
            extended: { name: 'Extended', tickers: { 'GOLD': 'XAU-USD', 'SILVER': 'XAG-USD', 'EUR': 'EUR-USD' } }
        };

        // API status tracking
        const apiStatus = {};
        let priceData = {};
        let currentCategory = 'all';

        // Fetch HIP-3 DEX data
        async function fetchHip3Dex(dex) {
            try {
                const response = await fetch('https://api.hyperliquid.xyz/info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'metaAndAssetCtxs', dex: dex })
                });
                const data = await response.json();
                const meta = data[0];
                const ctxs = data[1];
                
                const prices = {};
                meta.universe.forEach((market, i) => {
                    if (i < ctxs.length) {
                        const fullName = market.name;
                        const ticker = fullName.split(':')[1] || fullName;
                        const markPx = parseFloat(ctxs[i].markPx);
                        const oi = parseFloat(ctxs[i].openInterest || 0);
                        if (markPx > 0) {
                            prices[ticker] = { price: markPx, oi: oi, fullName: fullName };
                        }
                    }
                });
                
                apiStatus[dex] = { name: dex.toUpperCase(), status: 'live', prices: prices };
                return prices;
            } catch (error) {
                console.error(`HIP-3 ${dex} error:`, error);
                apiStatus[dex] = { name: dex.toUpperCase(), status: 'error', prices: {} };
                return null;
            }
        }

        // Fetch Aster DEX
        async function fetchAster() {
            try {
                const response = await fetch('https://fapi.asterdex.com/fapi/v1/ticker/price');
                const data = await response.json();
                const prices = {};
                data.forEach(item => {
                    prices[item.symbol] = parseFloat(item.price);
                });
                apiStatus.aster = { name: 'Aster', status: 'live', prices: prices };
                return prices;
            } catch (error) {
                console.error('Aster error:', error);
                apiStatus.aster = { name: 'Aster', status: 'error', prices: {} };
                return null;
            }
        }

        // Fetch Extended via proxy
        async function fetchExtended() {
            try {
                const response = await fetch('/api/extended');
                const data = await response.json();
                const prices = {};
                if (data.status === 'OK' && data.data) {
                    data.data.forEach(market => {
                        if (market.marketStats && market.marketStats.lastPrice) {
                            prices[market.name] = parseFloat(market.marketStats.lastPrice);
                        }
                    });
                }
                apiStatus.extended = { name: 'Extended', status: 'live', prices: prices };
                return prices;
            } catch (error) {
                console.error('Extended error:', error);
                apiStatus.extended = { name: 'Extended', status: 'error', prices: {} };
                return null;
            }
        }

        // Update all prices
        async function updatePrices() {
            document.getElementById('statusDot').className = 'status-dot loading';
            
            const fetchPromises = [
                ...HIP3_DEXS.map(dex => fetchHip3Dex(dex)),
                fetchAster(),
                fetchExtended()
            ];
            
            const results = await Promise.all(fetchPromises);
            const [xyzData, flxData, vntlData, hynaData, asterData, extendedData] = results;

            priceData = {};
            
            const hip3Results = { xyz: xyzData, flx: flxData, vntl: vntlData, hyna: hynaData };
            
            for (const [dex, data] of Object.entries(hip3Results)) {
                if (!data) continue;
                for (const [ticker, info] of Object.entries(data)) {
                    if (!priceData[ticker]) {
                        priceData[ticker] = {
                            ticker: ticker,
                            category: ASSET_CATEGORIES[ticker] || 'other',
                            icon: ASSET_ICONS[ticker] || 'üìà',
                            prices: {}
                        };
                    }
                    priceData[ticker].prices[dex] = {
                        price: info.price,
                        oi: info.oi,
                        isLive: true,
                        dexName: apiStatus[dex]?.name || dex.toUpperCase()
                    };
                }
            }

            if (asterData) {
                for (const [ticker, mapping] of Object.entries(EXTERNAL_DEXS.aster.tickers)) {
                    if (priceData[ticker] && asterData[mapping]) {
                        priceData[ticker].prices.aster = {
                            price: asterData[mapping],
                            isLive: true,
                            dexName: 'Aster'
                        };
                    }
                }
            }

            if (extendedData) {
                for (const [ticker, mapping] of Object.entries(EXTERNAL_DEXS.extended.tickers)) {
                    if (priceData[ticker] && extendedData[mapping]) {
                        priceData[ticker].prices.extended = {
                            price: extendedData[mapping],
                            isLive: true,
                            dexName: 'Extended'
                        };
                    }
                }
            }

            renderApiStatus();
            renderGrid();
            updateStats();
            
            document.getElementById('statusDot').className = 'status-dot live';
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        function renderApiStatus() {
            const container = document.getElementById('apiStatus');
            container.innerHTML = '<span style="color:#666">API Status:</span>';
            
            Object.entries(apiStatus).forEach(([key, api]) => {
                const div = document.createElement('div');
                div.className = `api-item ${api.status}`;
                const count = Object.keys(api.prices || {}).length;
                div.innerHTML = `
                    <span class="status-dot ${api.status}"></span>
                    <span>${api.name} (${count})</span>
                `;
                container.appendChild(div);
            });
        }

        function calculateArb(prices) {
            const dexs = Object.entries(prices);
            if (dexs.length < 2) return null;
            
            let minPrice = Infinity, maxPrice = -Infinity;
            let buyDex = '', sellDex = '', buyDexName = '', sellDexName = '';
            
            dexs.forEach(([dex, data]) => {
                if (data.price < minPrice) { 
                    minPrice = data.price; 
                    buyDex = dex;
                    buyDexName = data.dexName;
                }
                if (data.price > maxPrice) { 
                    maxPrice = data.price; 
                    sellDex = dex;
                    sellDexName = data.dexName;
                }
            });
            
            const spread = ((maxPrice - minPrice) / minPrice) * 100;
            if (spread > 0.05 && buyDex !== sellDex) {
                return { 
                    spread: spread.toFixed(3), 
                    buyDex, sellDex, 
                    buyDexName, sellDexName,
                    buyPrice: minPrice, 
                    sellPrice: maxPrice 
                };
            }
            return null;
        }

        function formatPrice(price) {
            if (price >= 1000) return '$' + price.toLocaleString('en-US', { maximumFractionDigits: 2 });
            if (price >= 100) return '$' + price.toFixed(2);
            if (price >= 1) return '$' + price.toFixed(3);
            return '$' + price.toFixed(6);
        }

        function formatOI(oi) {
            if (!oi || oi === 0) return '';
            if (oi >= 1000000) return `OI: ${(oi/1000000).toFixed(1)}M`;
            if (oi >= 1000) return `OI: ${(oi/1000).toFixed(1)}K`;
            return `OI: ${oi.toFixed(0)}`;
        }

        function renderGrid() {
            const container = document.getElementById('assetGrid');
            container.innerHTML = '';

            const filteredAssets = Object.values(priceData).filter(asset => {
                if (currentCategory === 'all') return true;
                return asset.category === currentCategory;
            });

            filteredAssets.sort((a, b) => {
                const aArb = calculateArb(a.prices);
                const bArb = calculateArb(b.prices);
                if (aArb && !bArb) return -1;
                if (!aArb && bArb) return 1;
                if (aArb && bArb) return parseFloat(bArb.spread) - parseFloat(aArb.spread);
                const aCount = Object.keys(a.prices).length;
                const bCount = Object.keys(b.prices).length;
                if (bCount !== aCount) return bCount - aCount;
                return a.ticker.localeCompare(b.ticker);
            });

            if (filteredAssets.length === 0) {
                container.innerHTML = '<div class="no-data">No assets found for this category</div>';
                return;
            }

            filteredAssets.forEach(asset => {
                const arb = calculateArb(asset.prices);
                const card = document.createElement('div');
                card.className = `card ${arb ? 'has-arb' : ''}`;

                const dexCount = Object.keys(asset.prices).length;
                
                let pricesHtml = '';
                Object.entries(asset.prices)
                    .sort((a, b) => a[1].price - b[1].price)
                    .forEach(([dex, data]) => {
                        const isBestBuy = arb && dex === arb.buyDex;
                        const isBestSell = arb && dex === arb.sellDex;
                        const rowClass = isBestBuy ? 'best-buy' : (isBestSell ? 'best-sell' : '');
                        const oiStr = formatOI(data.oi);
                        
                        pricesHtml += `
                            <div class="price-row ${rowClass}">
                                <span class="dex-name">
                                    ${data.isLive ? '<span class="live-dot"></span>' : ''}
                                    ${data.dexName}
                                </span>
                                <span class="price">${formatPrice(data.price)}</span>
                                <span class="spread">${oiStr}</span>
                            </div>
                        `;
                    });

                let arbHtml = '';
                if (arb) {
                    arbHtml = `
                        <div class="arb-info">
                            <strong>${arb.spread}% spread</strong> ¬∑ 
                            Buy on ${arb.buyDexName} (${formatPrice(arb.buyPrice)}) ‚Üí 
                            Sell on ${arb.sellDexName} (${formatPrice(arb.sellPrice)})
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="card-header">
                        <span class="card-title">
                            ${asset.icon} ${asset.ticker}
                        </span>
                        <div style="display:flex;gap:4px;">
                            ${arb ? `<span class="card-badge arb">${arb.spread}%</span>` : ''}
                            <span class="card-badge">${dexCount} DEX${dexCount > 1 ? 's' : ''}</span>
                        </div>
                    </div>
                    ${pricesHtml}
                    ${arbHtml}
                `;

                container.appendChild(card);
            });
        }

        function updateStats() {
            const assets = Object.values(priceData);
            const uniqueDexs = new Set();
            let arbCount = 0;
            let liveFeeds = 0;

            assets.forEach(asset => {
                Object.keys(asset.prices).forEach(dex => uniqueDexs.add(dex));
                liveFeeds += Object.keys(asset.prices).length;
                if (calculateArb(asset.prices)) arbCount++;
            });

            document.getElementById('totalAssets').textContent = assets.length;
            document.getElementById('totalDexs').textContent = uniqueDexs.size;
            document.getElementById('arbCount').textContent = arbCount;
            document.getElementById('liveFeeds').textContent = liveFeeds;
        }

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentCategory = btn.dataset.cat;
                renderGrid();
            });
        });

        updatePrices();
        setInterval(updatePrices, 10000);
    </script>
</body>
</html>
