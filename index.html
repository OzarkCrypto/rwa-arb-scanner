<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RWA Perp DEX Arbitrage Scanner</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fff;
            color: #333;
            font-size: 12px;
            padding: 12px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .header h1 { font-size: 16px; font-weight: 600; }
        .status-bar { display: flex; gap: 12px; font-size: 10px; color: #666; }
        .status-item { display: flex; align-items: center; gap: 4px; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; }
        .status-dot.live { background: #22c55e; }
        .status-dot.error { background: #ef4444; }
        .status-dot.loading { background: #f59e0b; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .api-status {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 10px;
        }
        .api-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            background: #fff;
            border-radius: 3px;
            border: 1px solid #e5e5e5;
        }
        .api-item.live { border-color: #22c55e; }
        .api-item.error { border-color: #ef4444; opacity: 0.6; }

        .stats {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .stat { display: flex; gap: 4px; }
        .stat-value { font-weight: 600; color: #111; }
        .stat-label { color: #666; }

        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
        }
        .tab-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: #fff;
            color: #666;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        .tab-btn:hover { border-color: #999; }
        .tab-btn.active { background: #111; color: #fff; border-color: #111; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 8px;
        }
        .card {
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            padding: 10px;
            background: #fff;
        }
        .card.has-arb { border-color: #22c55e; background: #f0fdf4; }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #f0f0f0;
        }
        .asset-info { display: flex; align-items: center; gap: 6px; }
        .asset-icon { font-size: 14px; }
        .asset-name { font-weight: 600; font-size: 13px; }
        .asset-meta { font-size: 10px; color: #999; }
        .cat-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
            font-weight: 500;
        }
        .cat-badge.stock { background: #dbeafe; color: #1d4ed8; }
        .cat-badge.index { background: #ede9fe; color: #6d28d9; }
        .cat-badge.commodity { background: #fef3c7; color: #b45309; }
        .cat-badge.forex { background: #d1fae5; color: #047857; }
        .cat-badge.preipo { background: #fce7f3; color: #be185d; }

        .dex-table { width: 100%; }
        .dex-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 6px;
            border-radius: 3px;
        }
        .dex-row:nth-child(odd) { background: #f9fafb; }
        .dex-row.buy-highlight { background: #dcfce7; }
        .dex-row.sell-highlight { background: #fee2e2; }
        .dex-name {
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
            min-width: 80px;
        }
        .dex-ticker { color: #666; font-size: 10px; }
        .dex-price { font-family: 'SF Mono', Monaco, monospace; font-weight: 500; }
        .dex-type {
            font-size: 8px;
            padding: 1px 4px;
            border-radius: 2px;
            text-transform: uppercase;
        }
        .dex-type.live { background: #22c55e; color: #fff; }
        .dex-type.error { background: #ef4444; color: #fff; }
        .dex-type.hip3 { background: #8b5cf6; color: #fff; }
        .dex-type.core { background: #3b82f6; color: #fff; }
        .dex-type.perp { background: #6b7280; color: #fff; }
        .dex-type.spot { background: #f59e0b; color: #fff; }

        .arb-box {
            margin-top: 8px;
            padding: 6px 8px;
            background: #ecfdf5;
            border-radius: 4px;
            border: 1px solid #a7f3d0;
        }
        .arb-header { display: flex; justify-content: space-between; align-items: center; }
        .arb-spread { font-weight: 700; color: #059669; font-size: 14px; }
        .arb-label { font-size: 10px; color: #047857; }
        .arb-detail { font-size: 10px; color: #065f46; margin-top: 4px; }
        .arb-action { font-weight: 600; }
        .arb-action.buy { color: #16a34a; }
        .arb-action.sell { color: #dc2626; }

        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç RWA Perp DEX Arbitrage Scanner</h1>
        <div class="status-bar">
            <div class="status-item">
                <span class="status-dot loading" id="statusDot"></span>
                <span>Last: <span id="lastUpdate">--:--:--</span></span>
            </div>
            <div class="status-item">Auto-refresh: 15s</div>
        </div>
    </div>

    <div class="api-status" id="apiStatus">
        <span style="color:#666">API Status:</span>
    </div>

    <div class="stats">
        <div class="stat"><span class="stat-value" id="totalAssets">0</span><span class="stat-label">Assets</span></div>
        <div class="stat"><span class="stat-value" id="totalDexs">0</span><span class="stat-label">DEXs</span></div>
        <div class="stat"><span class="stat-value" id="arbCount">0</span><span class="stat-label">Arb Opps</span></div>
        <div class="stat"><span class="stat-value" id="liveFeeds">0</span><span class="stat-label">Live Feeds</span></div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" data-cat="all">All</button>
        <button class="tab-btn" data-cat="stock">Stocks</button>
        <button class="tab-btn" data-cat="index">Index</button>
        <button class="tab-btn" data-cat="commodity">Commodities</button>
        <button class="tab-btn" data-cat="forex">Forex</button>
        <button class="tab-btn" data-cat="preipo">Pre-IPO</button>
    </div>

    <div class="grid" id="assetGrid"></div>

    <script>
        // Asset database with DEX mappings
        const assets = [
            { id: 'xyz100', name: 'Nasdaq 100', category: 'index', icon: 'üìä',
              dexs: { hyperliquid: { ticker: 'XYZ100', type: 'hip3' } } },
            
            { id: 'nvda', name: 'NVIDIA', category: 'stock', icon: 'üíö',
              dexs: { hyperliquid: { ticker: 'NVDA', type: 'hip3' } } },
            { id: 'tsla', name: 'Tesla', category: 'stock', icon: '‚ö°',
              dexs: { hyperliquid: { ticker: 'TSLA', type: 'hip3' } } },
            { id: 'aapl', name: 'Apple', category: 'stock', icon: 'üçé',
              dexs: { hyperliquid: { ticker: 'AAPL', type: 'hip3' } } },
            { id: 'googl', name: 'Google', category: 'stock', icon: 'üîç',
              dexs: { hyperliquid: { ticker: 'GOOGL', type: 'hip3' } } },
            { id: 'amzn', name: 'Amazon', category: 'stock', icon: 'üì¶',
              dexs: { hyperliquid: { ticker: 'AMZN', type: 'hip3' } } },
            { id: 'msft', name: 'Microsoft', category: 'stock', icon: 'ü™ü',
              dexs: { hyperliquid: { ticker: 'MSFT', type: 'hip3' } } },
            { id: 'meta', name: 'Meta', category: 'stock', icon: 'üë§',
              dexs: { hyperliquid: { ticker: 'META', type: 'hip3' } } },
            { id: 'pltr', name: 'Palantir', category: 'stock', icon: 'üîÆ',
              dexs: { hyperliquid: { ticker: 'PLTR', type: 'hip3' } } },
            { id: 'hood', name: 'Robinhood', category: 'stock', icon: 'üèπ',
              dexs: { hyperliquid: { ticker: 'HOOD', type: 'hip3' } } },
            { id: 'coin', name: 'Coinbase', category: 'stock', icon: 'ü™ô',
              dexs: { hyperliquid: { ticker: 'COIN', type: 'hip3' } } },
            { id: 'nflx', name: 'Netflix', category: 'stock', icon: 'üé¨',
              dexs: { hyperliquid: { ticker: 'NFLX', type: 'hip3' } } },
            { id: 'amd', name: 'AMD', category: 'stock', icon: 'üíª',
              dexs: { hyperliquid: { ticker: 'AMD', type: 'hip3' } } },
            { id: 'mstr', name: 'MicroStrategy', category: 'stock', icon: '‚Çø',
              dexs: { hyperliquid: { ticker: 'MSTR', type: 'hip3' } } },

            { id: 'spacex', name: 'SpaceX', category: 'preipo', icon: 'üöÄ',
              dexs: { hyperliquid: { ticker: 'SPACEX', type: 'hip3' } } },

            { id: 'gold', name: 'Gold', category: 'commodity', icon: 'ü•á',
              dexs: {
                  hyperliquid: { ticker: 'PAXG', type: 'core' },
                  aster: { ticker: 'XAUUSDT', type: 'perp' },
                  extended: { ticker: 'XAU-USD', type: 'perp' }
              }
            },
            { id: 'silver', name: 'Silver', category: 'commodity', icon: 'ü•à',
              dexs: {
                  aster: { ticker: 'XAGUSDT', type: 'perp' },
                  extended: { ticker: 'XAG-USD', type: 'perp' }
              }
            },
            { id: 'eurusd', name: 'EUR/USD', category: 'forex', icon: 'üí∂',
              dexs: {
                  extended: { ticker: 'EUR-USD', type: 'perp' }
              }
            }
        ];

        // API status tracking
        const apiStatus = {
            hyperliquid: { name: 'Hyperliquid', status: 'loading', prices: {} },
            aster: { name: 'Aster', status: 'loading', prices: {} },
            extended: { name: 'Extended', status: 'loading', prices: {} }
        };

        let priceData = {};
        let currentCategory = 'all';

        // Hyperliquid API
        async function fetchHyperliquid() {
            try {
                const response = await fetch('https://api.hyperliquid.xyz/info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'allMids' })
                });
                const data = await response.json();
                apiStatus.hyperliquid.status = 'live';
                apiStatus.hyperliquid.prices = data;
                return data;
            } catch (error) {
                console.error('Hyperliquid error:', error);
                apiStatus.hyperliquid.status = 'error';
                return null;
            }
        }

        // Aster DEX API
        async function fetchAster() {
            try {
                const response = await fetch('https://fapi.asterdex.com/fapi/v1/ticker/price');
                const data = await response.json();
                const prices = {};
                data.forEach(item => {
                    prices[item.symbol] = parseFloat(item.price);
                });
                apiStatus.aster.status = 'live';
                apiStatus.aster.prices = prices;
                return prices;
            } catch (error) {
                console.error('Aster error:', error);
                apiStatus.aster.status = 'error';
                return null;
            }
        }

        // Extended Exchange API (via proxy)
        async function fetchExtended() {
            try {
                const response = await fetch('/api/extended');
                const data = await response.json();
                const prices = {};
                if (data.data) {
                    data.data.forEach(market => {
                        if (market.marketStats && market.marketStats.lastPrice) {
                            prices[market.name] = parseFloat(market.marketStats.lastPrice);
                        }
                    });
                }
                apiStatus.extended.status = 'live';
                apiStatus.extended.prices = prices;
                return prices;
            } catch (error) {
                console.error('Extended error:', error);
                apiStatus.extended.status = 'error';
                return null;
            }
        }

        // Update all prices
        async function updatePrices() {
            document.getElementById('statusDot').className = 'status-dot loading';
            
            // Fetch all APIs in parallel
            const [hlData, asterData, extendedData] = await Promise.all([
                fetchHyperliquid(),
                fetchAster(),
                fetchExtended()
            ]);

            // Process prices for each asset
            assets.forEach(asset => {
                priceData[asset.id] = {};
                
                Object.entries(asset.dexs).forEach(([dex, info]) => {
                    let price = null;
                    let isLive = false;

                    if (dex === 'hyperliquid' && hlData) {
                        price = parseFloat(hlData[info.ticker]);
                        isLive = !!price;
                    } else if (dex === 'aster' && asterData) {
                        price = asterData[info.ticker];
                        isLive = !!price;
                    } else if (dex === 'extended' && extendedData) {
                        price = extendedData[info.ticker];
                        isLive = !!price;
                    }

                    if (price && !isNaN(price)) {
                        priceData[asset.id][dex] = {
                            price,
                            ticker: info.ticker,
                            type: info.type,
                            isLive
                        };
                    }
                });
            });

            renderApiStatus();
            renderGrid();
            updateStats();
            
            document.getElementById('statusDot').className = 'status-dot live';
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        function renderApiStatus() {
            const container = document.getElementById('apiStatus');
            container.innerHTML = '<span style="color:#666">API Status:</span>';
            
            Object.entries(apiStatus).forEach(([key, api]) => {
                const div = document.createElement('div');
                div.className = `api-item ${api.status}`;
                div.innerHTML = `
                    <span class="status-dot ${api.status}"></span>
                    <span>${api.name}</span>
                `;
                container.appendChild(div);
            });
        }

        function calculateArb(prices) {
            const dexs = Object.entries(prices);
            if (dexs.length < 2) return null;
            
            let minPrice = Infinity, maxPrice = -Infinity;
            let buyDex = '', sellDex = '';
            
            dexs.forEach(([dex, data]) => {
                if (data.price < minPrice) { minPrice = data.price; buyDex = dex; }
                if (data.price > maxPrice) { maxPrice = data.price; sellDex = dex; }
            });
            
            const spread = ((maxPrice - minPrice) / minPrice) * 100;
            if (spread > 0.02) {
                return { spread: spread.toFixed(3), buyDex, sellDex, buyPrice: minPrice, sellPrice: maxPrice };
            }
            return null;
        }

        function formatPrice(price) {
            if (price >= 1000) return price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (price >= 100) return price.toFixed(2);
            if (price >= 1) return price.toFixed(4);
            return price.toFixed(6);
        }

        function renderGrid() {
            const grid = document.getElementById('assetGrid');
            grid.innerHTML = '';
            
            const filtered = currentCategory === 'all' ? assets : assets.filter(a => a.category === currentCategory);
            
            filtered.forEach(asset => {
                const prices = priceData[asset.id] || {};
                const arb = calculateArb(prices);
                
                // Only show assets with at least one live price
                if (Object.keys(prices).length === 0) return;
                
                const sortedDexs = Object.entries(prices).sort((a, b) => b[1].price - a[1].price);

                const card = document.createElement('div');
                card.className = `card ${arb ? 'has-arb' : ''}`;
                
                let dexRows = sortedDexs.map(([dex, data]) => {
                    const isHighest = arb && dex === arb.sellDex;
                    const isLowest = arb && dex === arb.buyDex;
                    const rowClass = isHighest ? 'sell-highlight' : isLowest ? 'buy-highlight' : '';
                    const statusClass = data.isLive ? 'live' : 'error';
                    
                    return `
                        <div class="dex-row ${rowClass}">
                            <div class="dex-name">
                                ${dex.charAt(0).toUpperCase() + dex.slice(1)}
                                <span class="dex-ticker">${data.ticker}</span>
                            </div>
                            <div style="display:flex;align-items:center;gap:6px;">
                                <span class="dex-price">$${formatPrice(data.price)}</span>
                                <span class="dex-type ${statusClass}">${data.isLive ? 'LIVE' : 'ERR'}</span>
                            </div>
                        </div>
                    `;
                }).join('');

                let arbBox = '';
                if (arb) {
                    arbBox = `
                        <div class="arb-box">
                            <div class="arb-header">
                                <span class="arb-spread">+${arb.spread}%</span>
                                <span class="arb-label">Spread</span>
                            </div>
                            <div class="arb-detail">
                                <span class="arb-action buy">BUY ${arb.buyDex}</span> @ $${formatPrice(arb.buyPrice)} ‚Üí 
                                <span class="arb-action sell">SELL ${arb.sellDex}</span> @ $${formatPrice(arb.sellPrice)}
                            </div>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="card-header">
                        <div class="asset-info">
                            <span class="asset-icon">${asset.icon}</span>
                            <div>
                                <div class="asset-name">${asset.name}</div>
                                <div class="asset-meta">${Object.keys(prices).length} DEXs</div>
                            </div>
                        </div>
                        <span class="cat-badge ${asset.category}">${asset.category}</span>
                    </div>
                    <div class="dex-table">${dexRows}</div>
                    ${arbBox}
                `;
                
                grid.appendChild(card);
            });
        }

        function updateStats() {
            const assetsWithPrices = Object.keys(priceData).filter(id => Object.keys(priceData[id]).length > 0);
            document.getElementById('totalAssets').textContent = assetsWithPrices.length;
            
            const dexSet = new Set();
            const liveCount = { count: 0 };
            Object.values(priceData).forEach(assetPrices => {
                Object.entries(assetPrices).forEach(([dex, data]) => {
                    dexSet.add(dex);
                    if (data.isLive) liveCount.count++;
                });
            });
            document.getElementById('totalDexs').textContent = dexSet.size;
            document.getElementById('liveFeeds').textContent = liveCount.count;
            
            let arbCount = 0;
            Object.values(priceData).forEach(prices => {
                if (calculateArb(prices)) arbCount++;
            });
            document.getElementById('arbCount').textContent = arbCount;
        }

        // Tab click handlers
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentCategory = btn.dataset.cat;
                renderGrid();
            });
        });

        // Initialize
        updatePrices();
        setInterval(updatePrices, 15000);
    </script>
</body>
</html>
